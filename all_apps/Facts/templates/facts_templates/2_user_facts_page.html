{% extends 'base.html' %}

{% block content %}

{% load static %}
<link rel="stylesheet" href="{% static '2_user_facts_page.css' %}">

<div class="user_facts_wrapper">


    <div class="col">
        <div class="column_name">
            Manage Categories
        </div>
        <div class="cat_crud_wrapper">
            <form action="" id="add_category_form" method="POST">
                <input type="hidden" id="add_category_csrf" name="csrfmiddlewaretoken" value="{{csrf_token}}">
                <label for="add_category">Add Category:</label> <input type="text" name="add_category">
                <button id="cat_add_btn" type="submit">Add</button>
            </form>

            <div id="categories_list">

            </div>

        </div>


    </div>


    <div class="col">
        <div class="column_name">
            Manage Facts
        </div>
        <div class="cat_crud_wrapper">
            <form action="" method="POST">
                {% csrf_token %}

                <label for="add_category">Add Category:</label> <input type="text" name="add_category">

            </form>

        </div>
    </div>

    <div class="col">
        <div class="column_name">
            Test Your Facts
        </div>
        <div class="cat_crud_wrapper">
            <form action="" method="POST">
                {% csrf_token %}

                <label for="add_category">Add Category</label> <input type="text" name="add_category">

            </form>

        </div>
    </div>



</div>

<script type="text/javascript">

    getCategories();


    async function SaveCatFetch(input_id, old_cat_name, csrf_id ){
        console.log(input_id)
        console.log(old_cat_name)
        console.log(csrf_id)

        let input_line = document.getElementById(input_id);
        let new_cat_name = input_line.value;
        let csrf = document.getElementById(csrf_id).value
        
        url = "{% url 'edit_category_fetch' %}";

        let body ={
                    'old_name':old_cat_name,
                    'new_name':new_cat_name,
                    'api_key_fetch':'{{api_key_fetch}}'
        }


        fetch(url,
            {
                method:'POST',
                headers: {
                            'Content-type':'application/json',
                            'Accept': 'application/json',
                            'X-CSRFToken': csrf
                        },
                
                body: JSON.stringify(body)
            }

        )
        .then( (response)=> response.json())
        .then( function(data){

            console.log(data)

        })
    
        
    }

    async function EditToSave(line_id, edit_btn_id,) {
        let edit_btn = document.getElementById(edit_btn_id)
        let line = document.getElementById(line_id)
        console.log(line)
        
        let new_input =
            `
            
                <input id="${line_id}_csrf" type="hidden" name="csrfmiddlewaretoken" value={{csrf_token}}>
                <input id="${line_id}_input" 
                       name="${line_id}_input" 
                       type="text" 
                       value=${line.textContent}>
            
            `
        
        let new_form_element = document.createElement('form');
        new_form_element.innerHTML = new_input;
        
        line.replaceWith(new_form_element)

        let save_btn = document.createElement('button');
        save_btn.id = `"${line_id}_save_btn"`;
        save_btn.innerHTML = "Save";

        edit_btn.replaceWith(save_btn);
        

        
        save_btn.addEventListener('click',function(){

            SaveCatFetch(`${line_id}_input`,line.textContent,`${line_id}_csrf`)

            

        })
        




    }


    async function getCategories() {

        let url = '{% url "user_categories_fetch" %}?api_key_fetch={{api_key_fetch}}'

        document.getElementById('categories_list').innerHTML = ""

        fetch(url)
            .then((response) => response.json())
            .then(function (data) {
                let count = 1;

                for (let cat of data) {
                    var cat_item = `

                    <div class="line">

                        <div class="category_name"  >
                
                            <span id=count_${count}>${count})</span> 
                            <span id=${cat.category} name=${cat.category}>${cat.category}</span>
                
                        </div>
              
                        <div class='actions'>
                            <button id=edit_${cat.category}_btn  >Edit</button>           
                                
                            <button id=delete_${cat.category}_btn>Delete</button>
                
                        </div>
        
                    </div>`

                    
                    document.getElementById('categories_list').insertAdjacentHTML('beforeend', cat_item)
                    count += 1;

                    let edit_btn = document.getElementById(`edit_${cat.category}_btn`);

                    edit_btn.addEventListener('click', function(){

                        EditToSave( `${cat.category}`,`edit_${cat.category}_btn` )

                    })

                    

                }

            })

    }










</script>

{% endblock%}