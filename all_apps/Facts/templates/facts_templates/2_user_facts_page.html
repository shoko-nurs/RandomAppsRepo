{% extends 'base.html' %}

{% block content %}

{% load static %}
<link rel="stylesheet" href="{% static '2_user_facts_page.css' %}">

<div class="user_facts_wrapper">


    <div class="col">
        <div class="column_name">
            Manage Categories
        </div>
        <div class="cat_crud_wrapper">
            <form action="" method="POST">
                {% csrf_token %}
                
                <label for="add_category">Add Category:</label> <input type="text" name="add_category">
                <button id="cat_add_btn" type="submit">Add</button>
            </form>
            
            <div id="categories_list">

            </div>
            
        </div>


    </div>
    

    <div class="col">
        <div class="column_name">
            Manage Facts
        </div>
        <div class="cat_crud_wrapper">
            <form action="" method="POST">
                {% csrf_token %}
                
                <label for="add_category">Add Category:</label> <input type="text" name="add_category">

            </form>

        </div>
    </div>

    <div class="col">
        <div class="column_name">
            Test Your Facts
        </div>
        <div class="cat_crud_wrapper">
            <form action="" method="POST">
                {% csrf_token %}
                
                <label for="add_category">Add Category</label> <input type="text" name="add_category">

            </form>

        </div>
    </div>



</div>

<script type="text/javascript">

    
    async function SaveEditedCat(old_name, new_name, csrf_id, form_id, count, button_id){
        
    

        let csrf_token = document.getElementById(csrf_id).value;

        let body = {
            "old_name": old_name,
            "new_name": new_name,
            'api_key_fetch':'{{api_key_fetch}}',
            
        }

       

        url = "{%url 'edit_category_fetch'%}"

        fetch(url,
            {
                method:"POST",
                headers:{
                    'X-CSRFToken': csrf_token,
                    'Content-Type': 'application/json', 
                    'Accept': 'application/json',
                    
                },

                body:JSON.stringify(body)
                
            }
        )   
            .then( function(response){

                
                return response.json()
                
            })

            .then( function(data){
                
                let new_category_name = data.message;

                document.getElementById(form_id).innerHTML=
                `
                <span id=count_${count}>  ${count})   </span> 
                <span id=${new_category_name} name=${new_category_name}>${new_category_name}</span> 

                `
                document.getElementById(button_id).innerHTML = "Edit";
                document.getElementById(button_id).addEventListener('click', function(){

                    editCategory(new_category_name, count,`count_${count}`,`edit_${new_category_name}`)
                })

            })


        
        
    }

    // ///////////////////////////////////////////////////////////////////////


    async function editCategory (id, count, count_id, button_id){

        let category_old_text = id;

        let category_html = document.getElementById(id);
        
        let count_html = document.getElementById(count_id);
        
        

        count_html.innerHTML = "";

        category_html.innerHTML = 
        
        `
        <form style="" id=${id}_form>
            <input id ="${id}_csrf" name="csrfmiddlewaretoken" type="hidden" value="{{ csrf_token }}">
            <input id="id_${category_html.textContent}" 
                   type="text" 
                   value="${category_html.textContent}" 
                   style="text-align:left;">               
        </form>    
        `

        let input = document.getElementById(`id_${category_old_text}`);  
        let end = input.value.length;
        input.setSelectionRange(end, end);
        document.getElementById(`id_${category_old_text}`).focus();


        let new_text=input.value;
        input.addEventListener('input', function(){
            new_text = input.value;

        })

    
        let edit_btn = document.getElementById(button_id);

        edit_btn.textContent = "Save"
       
        
        edit_btn.onclick = function(){
    
            SaveEditedCat(category_old_text, new_text,`${id}_csrf`,`${id}_form`, count, button_id);
            

        }
    
        

    }


    async function getCategories(){
        
        let url = '{% url "user_categories_fetch" %}?api_key_fetch={{api_key_fetch}}'
        let id = 'categories_list';
        document.getElementById(id).innerHTML=""
        
        fetch(url)
        .then((response)=>response.json())
        .then(function(data){
            
            let count = 1 ;
            for(let cat of data){
                var cat_item = `

        <div class="line">

            <div class="category_name"  >
                
                <span id=count_${count}>${count})</span> 
                <span id=${cat.category} name=${cat.category}>${cat.category}</span>
                
            </div>
            
                
            
            <div class='actions'>
                <button id=edit_${cat.category} 
                        onclick=editCategory("${cat.category}",${count},"count_${count}","edit_${cat.category}")
                        
                        >Edit</button>
                <button id=delete_${cat.category}>Delete</button>
    
            </div>
        
        </div>`
                

                
                    
                document.getElementById(id).innerHTML += cat_item;
                count+=1;

                }


        })

    }
    
    getCategories()
        

   

</script>

{% endblock%}